var baseController = require('../controller/base')
var onHeaders      = require('on-headers')
/*
  We only allow a maximum of 20 seconds for returning a response.
  After that, a proper error response is given below.
*/
module.exports = function(req, res, next){
  var ms      = 60000 
  var message = '\
  Sorry about that! Its seems Built.io Backend Extension server is behaving badly! \
  Contact support.backend.com to check the actual issue.\
  '
  var id
  if(process.env.NODE_ENV !== 'test'){
    id = setTimeout(function(){
      req.emit('timeout', ms)
    }, ms)

    req.on('timeout', function(){
      if (res.headersSent) 
        return;
      
      return baseController.resError(req, res, {
        error_message: message
      })

    })

  }
  
  req.clearTimeout = function(){
    clearTimeout(id)
  }

  onHeaders(res, function(){
    clearTimeout(id)
  })

  next();
}