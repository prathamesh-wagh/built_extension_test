var onHeaders = require('on-headers')
/*
  Logs the specifics of this request onto the console,
  sort of like an access log. 
*/
var apiKey = 'application_api_key'

module.exports = function(req, res, next) {
  if (process.env.NODE_ENV !== 'test') {
    var url    = req.url
    var header = req.headers['X-Forwarded-For'] || req.connection.remoteAddress
    var method = req.method

    req.logID  = Math.floor(Math.random()*100000)
    var start  = new Date
    
    var requestLog = {
      'event'     : 'START',
      'id'        : req.logID,
      'header'    : header,
      'timestamp' : new Date,
      'method'    : method,
      'url'       : url
    }
    if(req.headers[apiKey] || (req.params && req.params[apiKey.toUpperCase()])){
      requestLog['api_key'] = req.headers[apiKey] || req.params[apiKey.toUpperCase()] 
    }
    req.logger.log(JSON.stringify(requestLog))

    onHeaders(res, function() {
      req.params      = req.params || {}
      var duration    = new Date - start
      var responseLog = {}
      responseLog     = {
        'event'     : 'STOP',
        'id'        : req.logID,
        'header'    : header,
        'timestamp' : new Date,
        'method'    : method,
        'url'       : url,
        'duration'  : duration
      }
      if(req.headers[apiKey] || (req.params && req.params[apiKey.toUpperCase()])){
        responseLog['api_key'] = req.headers[apiKey] || req.params[apiKey.toUpperCase()] 
      }
      
      req.logger.log(JSON.stringify(responseLog))
    })
  }

  next()
}
