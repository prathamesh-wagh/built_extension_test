/*
  A middleware to coalesce the query and body portions of the request,
  ala rails.
*/
module.exports = function(req, res, next) {
  if(req.query.query){
    try{
      req.query.query = JSON.parse(req.query.query)
    }catch(e){}
  }
  req.payload       = utils.extend({}, req.query, req.body)

  // PARAM support
  if (req.payload.PARAM) {
    var PARAM = {}
    try {
      PARAM = JSON.parse(req.payload.PARAM)
    } catch(e) {}
    req.payload = utils.extend(req.payload, PARAM)
  }
  next()
}